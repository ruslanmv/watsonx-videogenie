name: Frontend & Backend Smoke Test

on:
  push:
    branches: [ main ]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    env:
      BACKEND_PORT: 8000
      FRONTEND_PORT: 3000

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- Back‑end setup ---
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Python dependencies
        working-directory: services/avatar-service
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install fastapi uvicorn requests pydantic

      - name: Start Back‑end (avatar‑service)
        working-directory: services/avatar-service
        run: |
          source .venv/bin/activate
          uvicorn app.main:app --host 0.0.0.0 --port $BACKEND_PORT &
          echo "Waiting for back‑end to be ready..."
          for i in $(seq 1 15); do
            if curl -s http://localhost:$BACKEND_PORT/avatars >/dev/null; then
              echo "Back‑end is up!"
              break
            fi
            sleep 1
          done

      # --- Front‑end setup ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install & Build Front‑end
        working-directory: frontend
        run: |
          npm ci
          npm run build
          npx serve -s dist -l $FRONTEND_PORT &
          echo "Waiting for front‑end to be ready..."
          for i in $(seq 1 15); do
            if curl -s http://localhost:$FRONTEND_PORT/ >/dev/null; then
              echo "Front‑end is up!"
              break
            fi
            sleep 1
          done

      # --- Smoke tests ---
      - name: Smoke Test Back‑end
        run: |
          echo "GET /avatars →"
          curl -i http://localhost:$BACKEND_PORT/avatars

      - name: Smoke Test Front‑end
        run: |
          echo "GET index.html →"
          curl -i http://localhost:$FRONTEND_PORT/

      # — Cleanup background processes —
      - name: Kill background processes
        run: |
          pkill -f "uvicorn"
          pkill -f "serve"
